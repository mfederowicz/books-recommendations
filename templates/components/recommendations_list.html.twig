<div class="space-y-4">
  {% if recommendations is empty %}
    <!-- Placeholder dla rekomendacji -->
    <div class="bg-white rounded-lg shadow-sm border p-8 text-center">
      <div class="text-gray-400 mb-4">
        <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">{{ 'dashboard.no_recommendations'|trans }}</h3>
      <p class="text-gray-500">{{ 'dashboard.add_description_message'|trans }}</p>
    </div>
  {% else %}
    <!-- Lista rekomendacji -->
    {% for recommendation in recommendations %}
      <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
        <!-- Klikalna część - otwiera modal -->
        <div class="cursor-pointer recommendation-row" data-recommendation-id="{{ recommendation.id }}">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-start justify-between">
                <h3 class="text-lg font-semibold text-gray-900">{{ 'dashboard.recommendation_prefix'|trans({'%id%': recommendation.id}) }}</h3>
                <div class="flex items-center space-x-2 text-sm">
                  <span class="text-green-600 font-medium">{{ recommendation.foundBooksCount }} {{ 'dashboard.books_found'|trans }}</span>
                  <span class="text-gray-400">•</span>
                  <span class="text-gray-500">{{ recommendation.lastSearchAt ? recommendation.lastSearchAt|date('M j, H:i') : 'dashboard.never_searched'|trans }}</span>
                </div>
              </div>
              <p class="text-gray-600 mt-1 line-clamp-2">{{ recommendation.shortDescription }}</p>
              <div class="mt-3 flex flex-wrap gap-2">
                {% for tag in recommendation.tags %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                    {{ tag.name }}
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Przyciski akcji -->
        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
          <button
            class="text-indigo-600 hover:text-indigo-800 text-sm font-medium show-books-btn"
            data-recommendation-id="{{ recommendation.id }}"
          >
            {{ 'dashboard.show_books'|trans }}
          </button>

          <button
            class="text-red-600 hover:text-red-800 text-sm font-medium delete-recommendation-btn"
            data-recommendation-id="{{ recommendation.id }}"
            type="button"
          >
            {{ 'dashboard.delete'|trans }}
          </button>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

<!-- Modal dla szczegółów rekomendacji -->
<div id="recommendation-modal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
  <div class="relative mx-auto w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-xl rounded-lg bg-white" id="modal-container">
    <!-- Nagłówek modala -->
    <div class="flex justify-between items-center p-4 sm:p-6 border-b border-gray-200">
      <h3 class="text-lg sm:text-2xl font-bold text-gray-900">{{ 'dashboard.recommendation_details'|trans }}</h3>
      <button onclick="closeRecommendationModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors">
        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Zawartość modala -->
    <div id="modal-content" class="max-h-[calc(95vh-100px)] sm:max-h-[calc(90vh-120px)] overflow-y-auto p-4 sm:p-6">
      <!-- Ładowanie -->
      <div class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
        <span class="ml-3 text-gray-600 text-lg">{{ 'dashboard.loading'|trans }}</span>
      </div>
    </div>
  </div>
</div>

<script>
// Funkcja otwierania modala z rekomendacją
function openRecommendationModal(recommendationId) {
  const modal = document.getElementById('recommendation-modal');

  // Pokaż modal
  modal.classList.remove('hidden');

  // Zapobiegaj scrollowaniu tła
  document.body.style.overflow = 'hidden';

  // Załaduj zawartość przez HTMX
  htmx.ajax('GET', '/recommendations/' + recommendationId + '/books', {
    target: '#modal-content',
    swap: 'innerHTML'
  });
}

// Funkcja zamykania modala
function closeRecommendationModal() {
  const modal = document.getElementById('recommendation-modal');

  // Ukryj modal
  modal.classList.add('hidden');

  // Przywróć scrollowanie tła
  document.body.style.overflow = 'auto';
}

// Funkcja usuwania rekomendacji
function deleteRecommendation(recommendationId) {
  // Zapobiegaj domyślnym akcjom (może być wywołane z onclick)
  if (window.event) {
    window.event.preventDefault();
    window.event.stopPropagation();
  }

  // Potwierdzenie usunięcia
  if (!confirm('Czy na pewno chcesz usunąć tę rekomendację?')) {
    return;
  }

  // HTMX request do usunięcia
  htmx.ajax('DELETE', '/recommendations/' + recommendationId, {
    target: '#global-messages',
    swap: 'innerHTML',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  }).then(() => {
    // Po usunięciu odśwież listę rekomendacji
    htmx.ajax('GET', '/recommendations/list', {
      target: '#recommendations-container',
      swap: 'innerHTML'
    });

    // Jeśli usunięto ostatnią rekomendację, przełącz na zakładkę dodawania
    setTimeout(() => {
      const recommendationsContainer = document.getElementById('recommendations-container');
      if (recommendationsContainer && recommendationsContainer.innerHTML.includes('no_recommendations')) {
        showTab('add-recommendation');
      }
    }, 100);
  });
}

// Event listeners dla przycisków i div'ów
document.addEventListener('click', function(e) {
  // Obsługa przycisków usunięcia (sprawdź najpierw, bo ma najwyższy priorytet)
  if (e.target.closest('.delete-recommendation-btn')) {
    e.preventDefault(); // Zapobiegaj domyślnej akcji
    e.stopPropagation(); // Zapobiegaj wywołaniu innych event listenerów
    const btn = e.target.closest('.delete-recommendation-btn');
    const recommendationId = btn.getAttribute('data-recommendation-id');
    if (recommendationId && !btn.disabled) { // Zapobiegaj wielokrotnemu wywołaniu
      btn.disabled = true; // Wyłącz przycisk tymczasowo
      deleteRecommendation(recommendationId);
      // Przywróć przycisk po krótkim czasie (na wypadek błędu)
      setTimeout(() => { btn.disabled = false; }, 1000);
    }
    return false; // Zatrzymaj dalsze przetwarzanie i domyślną akcję
  }

  // Obsługa przycisków "Pokaż książki"
  if (e.target.closest('.show-books-btn')) {
    e.stopPropagation(); // Zapobiegaj wywołaniu event listener dla wiersza
    const btn = e.target.closest('.show-books-btn');
    const recommendationId = btn.getAttribute('data-recommendation-id');
    if (recommendationId && !btn.disabled) { // Zapobiegaj wielokrotnemu wywołaniu
      btn.disabled = true; // Wyłącz przycisk tymczasowo
      openRecommendationModal(recommendationId);
      // Przywróć przycisk po krótkim czasie
      setTimeout(() => { btn.disabled = false; }, 1000);
    }
    return; // Zatrzymaj dalsze przetwarzanie
  }

  // Obsługa kliknięć na wiersze rekomendacji (tylko jeśli nie kliknięto na przycisk)
  if (e.target.closest('.recommendation-row')) {
    const row = e.target.closest('.recommendation-row');
    const recommendationId = row.getAttribute('data-recommendation-id');
    if (recommendationId) {
      openRecommendationModal(recommendationId);
    }
  }
});

// Zamknij modal po kliknięciu poza nim
document.getElementById('recommendation-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeRecommendationModal();
  }
});

// Zamknij modal klawiszem Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeRecommendationModal();
  }
});
</script>
